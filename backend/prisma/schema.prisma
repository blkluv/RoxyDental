// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  DOKTER
  PERAWAT
}

enum Gender {
  L // Laki-laki
  P // Perempuan
}

enum VisitStatus {
  WAITING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ServiceCategory {
  CONSULTATION
  SCALING
  FILLING
  EXTRACTION
  WHITENING
  ORTHODONTIC
  OTHER
}

enum ScheduleType {
  SHIFT
  MEETING
  ACTIVITY
}

enum LeaveType {
  SICK
  ANNUAL
  EMERGENCY
  UNPAID
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PaymentMethod {
  CASH
  TRANSFER
  CARD
  QRIS
}

enum PaymentStatus {
  PENDING
  PAID
  PARTIAL
  REFUNDED
}

enum CommissionStatus {
  PENDING
  PAID
}

model User {
  id               String   @id @default(uuid()) @db.Uuid
  username         String   @unique @db.VarChar(100)
  email            String   @unique @db.VarChar(255)
  passwordHash     String   @map("password_hash") @db.VarChar(255)
  role             UserRole
  fullName         String   @map("full_name") @db.VarChar(255)
  phone            String   @db.VarChar(20)
  specialization   String?  @db.VarChar(100)
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  visitsAsNurse         Visit[]          @relation("NurseVisits")
  treatmentsPerformed   Treatment[]      @relation("PerformedTreatments")
  schedules             Schedule[]
  leaveRequests         LeaveRequest[]   @relation("UserLeaveRequests")
  leaveApprovalsGiven   LeaveRequest[]   @relation("ApproverLeaveRequests")
  commissions           Commission[]

  @@map("users")
  @@index([role])
  @@index([isActive])
  @@index([email])
}

model Patient {
  id             String    @id @default(uuid()) @db.Uuid
  patientNumber  String    @unique @map("patient_number") @db.VarChar(50)
  fullName       String    @map("full_name") @db.VarChar(255)
  dateOfBirth    DateTime  @map("date_of_birth") @db.Date
  gender         Gender
  phone          String    @db.VarChar(20)
  email          String?   @db.VarChar(255)
  address        String?   @db.Text
  bloodType      String?   @map("blood_type") @db.VarChar(5)
  allergies      String?   @db.Text
  medicalHistory String?   @map("medical_history") @db.Text
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamp(6)

  // Relations
  visits     Visit[]
  treatments Treatment[]

  @@map("patients")
  @@index([patientNumber])
  @@index([fullName])
  @@index([phone])
}

model Service {
  id              String          @id @default(uuid()) @db.Uuid
  serviceCode     String          @unique @map("service_code") @db.VarChar(50)
  serviceName     String          @map("service_name") @db.VarChar(255)
  category        ServiceCategory
  description     String?         @db.Text
  basePrice       Decimal         @map("base_price") @db.Decimal(12, 2)
  commissionRate  Decimal         @map("commission_rate") @db.Decimal(5, 2)
  durationMinutes Int?            @map("duration_minutes")
  isActive        Boolean         @default(true) @map("is_active")
  createdAt       DateTime        @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt       DateTime        @updatedAt @map("updated_at") @db.Timestamp(6)

  // Relations
  treatments Treatment[]

  @@map("services")
  @@index([category])
  @@index([isActive])
  @@index([serviceCode])
}

model Visit {
  id             String      @id @default(uuid()) @db.Uuid
  patientId      String      @map("patient_id") @db.Uuid
  nurseId        String      @map("nurse_id") @db.Uuid
  visitNumber    String      @unique @map("visit_number") @db.VarChar(50)
  visitDate      DateTime    @map("visit_date") @db.Timestamp(6)
  queueNumber    Int         @map("queue_number")
  status         VisitStatus @default(WAITING)
  chiefComplaint String?     @map("chief_complaint") @db.Text
  bloodPressure  String?     @map("blood_pressure") @db.VarChar(20)
  notes          String?     @db.Text
  totalCost      Decimal     @default(0) @map("total_cost") @db.Decimal(12, 2)
  createdAt      DateTime    @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt      DateTime    @updatedAt @map("updated_at") @db.Timestamp(6)

  // Relations
  patient    Patient     @relation(fields: [patientId], references: [id], onDelete: Cascade)
  nurse      User        @relation("NurseVisits", fields: [nurseId], references: [id], onDelete: Restrict)
  treatments Treatment[]
  payments   Payment[]

  @@map("visits")
  @@index([patientId])
  @@index([nurseId])
  @@index([visitDate])
  @@index([status])
  @@index([queueNumber])
}

model Treatment {
  id             String   @id @default(uuid()) @db.Uuid
  visitId        String   @map("visit_id") @db.Uuid
  patientId      String   @map("patient_id") @db.Uuid
  serviceId      String   @map("service_id") @db.Uuid
  performedBy    String   @map("performed_by") @db.Uuid
  toothNumber    String?  @map("tooth_number") @db.VarChar(10)
  diagnosis      String?  @db.Text
  treatmentNotes String?  @map("treatment_notes") @db.Text
  quantity       Int      @default(1)
  unitPrice      Decimal  @map("unit_price") @db.Decimal(12, 2)
  discount       Decimal  @default(0) @db.Decimal(12, 2)
  subtotal       Decimal  @map("subtotal") @db.Decimal(12, 2)
  images         String[] @db.Text
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  // Relations
  visit       Visit        @relation(fields: [visitId], references: [id], onDelete: Cascade)
  patient     Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  service     Service      @relation(fields: [serviceId], references: [id], onDelete: Restrict)
  performer   User         @relation("PerformedTreatments", fields: [performedBy], references: [id], onDelete: Restrict)
  commissions Commission[]

  @@map("treatments")
  @@index([visitId])
  @@index([patientId])
  @@index([serviceId])
  @@index([performedBy])
  @@index([createdAt])
}

model Payment {
  id              String        @id @default(uuid()) @db.Uuid
  visitId         String        @map("visit_id") @db.Uuid
  paymentNumber   String        @unique @map("payment_number") @db.VarChar(50)
  paymentDate     DateTime      @map("payment_date") @db.Timestamp(6)
  paymentMethod   PaymentMethod @map("payment_method")
  amount          Decimal       @db.Decimal(12, 2)
  paidAmount      Decimal       @map("paid_amount") @db.Decimal(12, 2)
  changeAmount    Decimal       @default(0) @map("change_amount") @db.Decimal(12, 2)
  status          PaymentStatus @default(PENDING)
  referenceNumber String?       @map("reference_number") @db.VarChar(100)
  notes           String?       @db.Text
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamp(6)

  // Relations
  visit Visit @relation(fields: [visitId], references: [id], onDelete: Cascade)

  @@map("payments")
  @@index([visitId])
  @@index([paymentDate])
  @@index([status])
  @@index([paymentNumber])
}

model Schedule {
  id                String       @id @default(uuid()) @db.Uuid
  userId            String       @map("user_id") @db.Uuid
  title             String       @db.VarChar(255)
  description       String?      @db.Text
  scheduleType      ScheduleType @map("schedule_type")
  startDatetime     DateTime     @map("start_datetime") @db.Timestamp(6)
  endDatetime       DateTime     @map("end_datetime") @db.Timestamp(6)
  location          String?      @db.VarChar(255)
  isRecurring       Boolean      @default(false) @map("is_recurring")
  recurrencePattern String?      @map("recurrence_pattern") @db.VarChar(100)
  createdAt         DateTime     @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt         DateTime     @updatedAt @map("updated_at") @db.Timestamp(6)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("schedules")
  @@index([userId])
  @@index([startDatetime])
  @@index([scheduleType])
}

model LeaveRequest {
  id              String      @id @default(uuid()) @db.Uuid
  userId          String      @map("user_id") @db.Uuid
  approvedBy      String?     @map("approved_by") @db.Uuid
  startDate       DateTime    @map("start_date") @db.Date
  endDate         DateTime    @map("end_date") @db.Date
  leaveType       LeaveType   @map("leave_type")
  reason          String      @db.Text
  status          LeaveStatus @default(PENDING)
  rejectionReason String?     @map("rejection_reason") @db.Text
  approvedAt      DateTime?   @map("approved_at") @db.Timestamp(6)
  createdAt       DateTime    @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt       DateTime    @updatedAt @map("updated_at") @db.Timestamp(6)

  // Relations
  requester User  @relation("UserLeaveRequests", fields: [userId], references: [id], onDelete: Cascade)
  approver  User? @relation("ApproverLeaveRequests", fields: [approvedBy], references: [id], onDelete: SetNull)

  @@map("leave_requests")
  @@index([userId])
  @@index([approvedBy])
  @@index([status])
  @@index([startDate])
}

model Commission {
  id               String           @id @default(uuid()) @db.Uuid
  userId           String           @map("user_id") @db.Uuid
  treatmentId      String           @map("treatment_id") @db.Uuid
  baseAmount       Decimal          @map("base_amount") @db.Decimal(12, 2)
  commissionRate   Decimal          @map("commission_rate") @db.Decimal(5, 2)
  commissionAmount Decimal          @map("commission_amount") @db.Decimal(12, 2)
  periodMonth      Int              @map("period_month")
  periodYear       Int              @map("period_year")
  status           CommissionStatus @default(PENDING)
  paidAt           DateTime?        @map("paid_at") @db.Timestamp(6)
  notes            String?          @db.Text
  createdAt        DateTime         @default(now()) @map("created_at") @db.Timestamp(6)

  // Relations
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  treatment Treatment @relation(fields: [treatmentId], references: [id], onDelete: Cascade)

  @@map("commissions")
  @@index([userId])
  @@index([treatmentId])
  @@index([periodMonth, periodYear])
  @@index([status])
}